<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Batch Job Monitor - DOT Toolkit</title>
  <!-- Google Fonts: Quicksand (Headlines) and PT Serif (Body) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=PT+Serif:wght@400;700&display=swap" rel="stylesheet">
  <!-- Material Design Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
  <link rel="stylesheet" href="../../popup/design-tokens.css">
  <link rel="stylesheet" href="batch-jobs.css">
</head>
<body>
  <div class="container">
    <header class="page-header">
      <div class="header-content">
        <h1>
          <span class="material-symbols-rounded">pending_actions</span>
          Batch Job Monitor
        </h1>
        <div class="header-actions">
          <button id="refreshBtn" class="btn btn-icon" title="Refresh Now">
            <span class="material-symbols-rounded">refresh</span>
          </button>
          <button id="settingsBtn" class="btn btn-icon" title="Settings">
            <span class="material-symbols-rounded">settings</span>
          </button>
        </div>
      </div>
      <div class="org-info">
        <strong>Org:</strong> <span id="orgUrl">Loading...</span>
      </div>
    </header>

    <!-- Settings Panel (hidden by default) -->
    <div id="settingsPanel" class="settings-panel hidden">
      <h3>Monitor Settings</h3>
      <div class="setting-item">
        <label for="refreshInterval">Auto-refresh interval:</label>
        <select id="refreshInterval">
          <option value="0">Disabled</option>
          <option value="15000">15 seconds</option>
          <option value="30000" selected>30 seconds</option>
          <option value="60000">1 minute</option>
          <option value="120000">2 minutes</option>
          <option value="300000">5 minutes</option>
        </select>
      </div>
      <div class="setting-item">
        <label>
          <input type="checkbox" id="notifyOnComplete" checked>
          Notify when job completes
        </label>
      </div>
      <div class="setting-item">
        <label>
          <input type="checkbox" id="notifyOnError" checked>
          Notify on job failure
        </label>
      </div>
      <div class="setting-item">
        <label for="jobHistoryHours">Show completed jobs from last:</label>
        <select id="jobHistoryHours">
          <option value="1">1 hour</option>
          <option value="6">6 hours</option>
          <option value="24" selected>24 hours</option>
          <option value="48">48 hours</option>
          <option value="168">7 days</option>
        </select>
      </div>
      <div class="setting-item">
        <label for="allowedClassNames">Allowed class names for filter (one per line):</label>
        <textarea id="allowedClassNames" rows="6" placeholder="Ctrl_CMP_Data_Migration_Batchable
Batch_Training
Batchable_Generate_PDF
Batchable_File_Updates"></textarea>
        <small class="help-text">These classes will be shown when "My Classes Only" filter is enabled</small>
      </div>
      <button id="closeSettingsBtn" class="btn btn-secondary">Close</button>
    </div>

    <!-- Summary Stats -->
    <div class="summary-section">
      <div class="stat-card">
        <span class="material-symbols-rounded stat-icon processing">hourglass_empty</span>
        <div class="stat-content">
          <span class="stat-value" id="activeCount">-</span>
          <span class="stat-label">Active</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-symbols-rounded stat-icon queued">queue</span>
        <div class="stat-content">
          <span class="stat-value" id="queuedCount">-</span>
          <span class="stat-label">Queued</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-symbols-rounded stat-icon completed">check_circle</span>
        <div class="stat-content">
          <span class="stat-value" id="completedCount">-</span>
          <span class="stat-label">Completed</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-symbols-rounded stat-icon failed">error</span>
        <div class="stat-content">
          <span class="stat-value" id="failedCount">-</span>
          <span class="stat-label">Failed</span>
        </div>
      </div>
    </div>

    <!-- Auto-refresh indicator -->
    <div class="refresh-indicator">
      <span id="lastRefresh">Last updated: --</span>
      <span id="autoRefreshStatus" class="auto-refresh-status">
        <span class="material-symbols-rounded">sync</span>
        Auto-refresh: <span id="refreshCountdown">--</span>
      </span>
    </div>

    <!-- Job Filters -->
    <div class="filter-section">
      <div class="filter-group">
        <label for="jobTypeFilter">Job Type:</label>
        <select id="jobTypeFilter">
          <option value="">All Types</option>
          <option value="BatchApex">Batch Apex</option>
          <option value="Future">Future</option>
          <option value="Queueable">Queueable</option>
          <option value="ScheduledApex">Scheduled</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="statusFilter">Status:</label>
        <select id="statusFilter">
          <option value="">All Statuses</option>
          <option value="Queued">Queued</option>
          <option value="Preparing">Preparing</option>
          <option value="Processing">Processing</option>
          <option value="Holding">Holding</option>
          <option value="Completed">Completed</option>
          <option value="Failed">Failed</option>
          <option value="Aborted">Aborted</option>
        </select>
      </div>
      <div class="filter-group">
        <input type="text" id="searchInput" placeholder="Search class name...">
      </div>
      <div class="filter-group filter-toggle">
        <label class="toggle-label">
          <input type="checkbox" id="filterByClassNames">
          <span>My Classes Only</span>
        </label>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="active">
        <span class="material-symbols-rounded">play_circle</span>
        Active Jobs
        <span class="badge" id="activeJobsBadge">0</span>
      </button>
      <button class="tab-btn" data-tab="completed">
        <span class="material-symbols-rounded">history</span>
        Completed
        <span class="badge" id="completedJobsBadge">0</span>
      </button>
      <button class="tab-btn" data-tab="scheduled">
        <span class="material-symbols-rounded">event_repeat</span>
        Scheduled
        <span class="badge" id="scheduledJobsBadge">0</span>
      </button>
    </div>

    <!-- Job Lists -->
    <div class="tab-content">
      <!-- Active Jobs Tab -->
      <div id="activeTab" class="tab-panel active">
        <div id="activeJobsContainer" class="jobs-container">
          <div class="loading-message">
            <span class="material-symbols-rounded spinning">sync</span>
            Loading active jobs...
          </div>
        </div>
        <div id="noActiveJobs" class="empty-state hidden">
          <span class="material-symbols-rounded">check_circle</span>
          <p>No active jobs running</p>
        </div>
      </div>

      <!-- Completed Jobs Tab -->
      <div id="completedTab" class="tab-panel hidden">
        <div id="completedJobsContainer" class="jobs-container">
          <div class="loading-message">
            <span class="material-symbols-rounded spinning">sync</span>
            Loading completed jobs...
          </div>
        </div>
        <div id="noCompletedJobs" class="empty-state hidden">
          <span class="material-symbols-rounded">inbox</span>
          <p>No completed jobs in the selected time range</p>
        </div>
      </div>

      <!-- Scheduled Jobs Tab -->
      <div id="scheduledTab" class="tab-panel hidden">
        <div id="scheduledJobsContainer" class="jobs-container">
          <div class="loading-message">
            <span class="material-symbols-rounded spinning">sync</span>
            Loading scheduled jobs...
          </div>
        </div>
        <div id="noScheduledJobs" class="empty-state hidden">
          <span class="material-symbols-rounded">event_busy</span>
          <p>No scheduled jobs found</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Abort Confirmation Modal -->
  <div id="abortModal" class="modal hidden">
    <div class="modal-content">
      <h3>Abort Job</h3>
      <p>Are you sure you want to abort this job?</p>
      <p class="modal-job-info">
        <strong>Class:</strong> <span id="abortJobClass">--</span><br>
        <strong>Status:</strong> <span id="abortJobStatus">--</span>
      </p>
      <div class="modal-actions">
        <button id="confirmAbortBtn" class="btn btn-danger">Abort Job</button>
        <button id="cancelAbortBtn" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Execute Now Confirmation Modal -->
  <div id="executeNowModal" class="modal hidden">
    <div class="modal-content">
      <h3>Execute Batch Job Now</h3>
      <p>This will execute the batch job immediately while keeping its schedule intact.</p>
      <p class="modal-job-info">
        <strong>Class:</strong> <span id="executeJobClass">--</span><br>
        <strong>Next Scheduled:</strong> <span id="executeJobNextRun">--</span>
      </p>
      <div class="modal-actions">
        <button id="confirmExecuteBtn" class="btn btn-primary">Execute Now</button>
        <button id="cancelExecuteBtn" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module" src="batch-jobs.js"></script>
</body>
</html>
